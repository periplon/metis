name: CD

on:
  push:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: write
  packages: write

jobs:
  version-and-tag:
    name: Version & Tag
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.cog_bump.outputs.version }}
      skipped: ${{ steps.cog_bump.outputs.skipped }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install cocogitto
        run: |
          mkdir -p /tmp/cocogitto
          curl -L https://github.com/cocogitto/cocogitto/releases/download/6.1.0/cocogitto-6.1.0-x86_64-unknown-linux-musl.tar.gz | tar xz -C /tmp/cocogitto
          find /tmp/cocogitto -name cog -type f -exec sudo mv {} /usr/local/bin/cog \;
          chmod +x /usr/local/bin/cog
          rm -rf /tmp/cocogitto
          cog --version

      - name: Semver Bump
        id: cog_bump
        run: |
          set -e

          # Default to skipped in case of errors
          echo "skipped=true" >> $GITHUB_OUTPUT

          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Dry run first
          NEXT_VERSION=$(cog bump --auto --dry-run || echo "")

          if [ -z "$NEXT_VERSION" ] || [ "$NEXT_VERSION" = "No conventional commits for your repository that required a bump" ]; then
            echo "No version bump needed."
            exit 0
          fi

          # We're doing a bump, so mark as not skipped
          echo "skipped=false" >> $GITHUB_OUTPUT

          # Perform bump
          cog bump --auto

          # Get the new version
          NEW_TAG=$(git describe --tags --abbrev=0)
          VERSION=${NEW_TAG#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Push changes (HEAD:main is crucial because we are in detached HEAD)
          git push origin HEAD:main
          git push origin $NEW_TAG

  build-ui:
    name: Build UI
    needs: version-and-tag
    if: needs.version-and-tag.outputs.skipped != 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Install cargo-binstall
        uses: cargo-bins/cargo-binstall@v1.10.1

      - name: Install cargo-leptos
        run: cargo binstall cargo-leptos -y

      - name: Build UI
        run: cargo leptos build --release
        env:
          LEPTOS_WASM_BINDGEN_VERSION: "0.2.105"
      
      - name: Prepare UI dist
        run: |
          mkdir -p ui/dist
          # Check possible output locations
          if [ -d "target/site" ]; then
            cp -r target/site/* ui/dist/
          elif [ -d "ui/target/site" ]; then
            cp -r ui/target/site/* ui/dist/
          elif [ -d "../target/site" ]; then
            cp -r ../target/site/* ui/dist/
          else
             echo "Could not find target/site directory. Listing dirs:"
             ls -R .
             ls -R ..
             exit 1
          fi
          # Verify dist
          ls -R ui/dist

      - name: Upload UI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ui-dist
          path: ui/dist

  build-binaries:
    name: Build Binary
    needs: [version-and-tag, build-ui]
    if: needs.version-and-tag.outputs.skipped != 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            name: metis-linux-amd64
          - os: macos-latest
            target: x86_64-apple-darwin
            name: metis-macos-amd64
          - os: macos-latest
            target: aarch64-apple-darwin
            name: metis-macos-arm64
          # Windows support can be tricky with just/make dependencies, disabling if simple cargo build isn't enough
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            name: metis-windows-amd64.exe

    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Download UI Artifact
        uses: actions/download-artifact@v4
        with:
          name: ui-dist
          path: ui/dist

      - name: Build
        run: cargo build --release --target ${{ matrix.target }}

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: target/${{ matrix.target }}/release/metis${{ matrix.os == 'windows-latest' && '.exe' || '' }}

  docker:
    name: Docker Build & Push
    needs: [version-and-tag, build-ui]
    if: needs.version-and-tag.outputs.skipped != 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Download UI Artifact
        uses: actions/download-artifact@v4
        with:
          name: ui-dist
          path: ui/dist
          
      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:latest
            ghcr.io/${{ github.repository }}:${{ needs.version-and-tag.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  release:
    name: Release
    needs: [version-and-tag, build-binaries]
    if: needs.version-and-tag.outputs.skipped != 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: v${{ needs.version-and-tag.outputs.version }}
          fetch-depth: 0

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.version-and-tag.outputs.version }}
          files: |
            artifacts/metis-linux-amd64/metis
            artifacts/metis-macos-amd64/metis
            artifacts/metis-macos-arm64/metis
            artifacts/metis-windows-amd64.exe/metis.exe
          generate_release_notes: true
